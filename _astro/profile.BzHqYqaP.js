import{s as b,l as d,m as y,n as N,o as P,q as V,r as z,t as B,v as I}from"./aes.Ce_Q33qD.js";var m=Symbol("verified"),j=e=>e instanceof Object;function Y(e){if(!j(e)||typeof e.kind!="number"||typeof e.content!="string"||typeof e.created_at!="number"||typeof e.pubkey!="string"||!e.pubkey.match(/^[a-f0-9]{64}$/)||!Array.isArray(e.tags))return!1;for(let t=0;t<e.tags.length;t++){let n=e.tags[t];if(!Array.isArray(n))return!1;for(let s=0;s<n.length;s++)if(typeof n[s]!="string")return!1}return!0}new TextDecoder("utf-8");var G=new TextEncoder,Q=class{generateSecretKey(){return b.utils.randomSecretKey()}getPublicKey(t){return d(b.getPublicKey(t))}finalizeEvent(t,n){const s=t;return s.pubkey=d(b.getPublicKey(n)),s.id=C(s),s.sig=d(b.sign(y(C(s)),n)),s[m]=!0,s}verifyEvent(t){if(typeof t[m]=="boolean")return t[m];const n=C(t);if(n!==t.id)return t[m]=!1,!1;try{const s=b.verify(y(t.sig),y(n),y(t.pubkey));return t[m]=s,s}catch{return t[m]=!1,!1}}};function X(e){if(!Y(e))throw new Error("can't serialize event with wrong or missing properties");return JSON.stringify([0,e.pubkey,e.created_at,e.kind,e.tags,e.content])}function C(e){let t=N(G.encode(X(e)));return d(t)}var k=new Q,Z=k.generateSecretKey,x=k.getPublicKey,ee=k.finalizeEvent;k.verifyEvent;var T=new TextDecoder("utf-8");new TextEncoder;var W=5e3;function F(e){let{prefix:t,words:n}=P.decode(e,W),s=new Uint8Array(P.fromWords(n));switch(t){case"nprofile":{let i=$(s);if(!i[0]?.[0])throw new Error("missing TLV 0 for nprofile");if(i[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");return{type:"nprofile",data:{pubkey:d(i[0][0]),relays:i[1]?i[1].map(o=>T.decode(o)):[]}}}case"nevent":{let i=$(s);if(!i[0]?.[0])throw new Error("missing TLV 0 for nevent");if(i[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");if(i[2]&&i[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(i[3]&&i[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"nevent",data:{id:d(i[0][0]),relays:i[1]?i[1].map(o=>T.decode(o)):[],author:i[2]?.[0]?d(i[2][0]):void 0,kind:i[3]?.[0]?parseInt(d(i[3][0]),16):void 0}}}case"naddr":{let i=$(s);if(!i[0]?.[0])throw new Error("missing TLV 0 for naddr");if(!i[2]?.[0])throw new Error("missing TLV 2 for naddr");if(i[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(!i[3]?.[0])throw new Error("missing TLV 3 for naddr");if(i[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"naddr",data:{identifier:T.decode(i[0][0]),pubkey:d(i[2][0]),kind:parseInt(d(i[3][0]),16),relays:i[1]?i[1].map(o=>T.decode(o)):[]}}}case"nsec":return{type:t,data:s};case"npub":case"note":return{type:t,data:d(s)};default:throw new Error(`unknown prefix ${t}`)}}function $(e){let t={},n=e;for(;n.length>0;){let s=n[0],i=n[1],o=n.slice(2,2+i);if(n=n.slice(2+i),o.length<i)throw new Error(`not enough data to read on TLV ${s}`);t[s]=t[s]||[],t[s].push(o)}return t}function L(e){return D("nsec",e)}function A(e){return D("npub",y(e))}function te(e,t){let n=P.toWords(t);return P.encode(e,n,W)}function D(e,t){return te(e,t)}new TextDecoder("utf-8");var ne=new TextEncoder;function se(e,t,n){const s=e instanceof Uint8Array?e:y(e),i=V.getSharedSecret(s,y("02"+t)),o=ie(i);let r=Uint8Array.from(z(16)),c=ne.encode(n),u=B(o,r).encrypt(c),f=I.encode(new Uint8Array(u)),g=I.encode(new Uint8Array(r.buffer));return`${f}?iv=${g}`}function ie(e){return e.slice(1,33)}var p=Symbol("verified"),oe=e=>e instanceof Object;function re(e){if(!oe(e)||typeof e.kind!="number"||typeof e.content!="string"||typeof e.created_at!="number"||typeof e.pubkey!="string"||!e.pubkey.match(/^[a-f0-9]{64}$/)||!Array.isArray(e.tags))return!1;for(let t=0;t<e.tags.length;t++){let n=e.tags[t];if(!Array.isArray(n))return!1;for(let s=0;s<n.length;s++)if(typeof n[s]!="string")return!1}return!0}new TextDecoder("utf-8");var ae=new TextEncoder;function v(e){try{e.indexOf("://")===-1&&(e="wss://"+e);let t=new URL(e);return t.protocol==="http:"?t.protocol="ws:":t.protocol==="https:"&&(t.protocol="wss:"),t.pathname=t.pathname.replace(/\/+/g,"/"),t.pathname.endsWith("/")&&(t.pathname=t.pathname.slice(0,-1)),(t.port==="80"&&t.protocol==="ws:"||t.port==="443"&&t.protocol==="wss:")&&(t.port=""),t.searchParams.sort(),t.hash="",t.toString()}catch{throw new Error(`Invalid URL: ${e}`)}}var ce=class{generateSecretKey(){return b.utils.randomSecretKey()}getPublicKey(e){return d(b.getPublicKey(e))}finalizeEvent(e,t){const n=e;return n.pubkey=d(b.getPublicKey(t)),n.id=_(n),n.sig=d(b.sign(y(_(n)),t)),n[p]=!0,n}verifyEvent(e){if(typeof e[p]=="boolean")return e[p];const t=_(e);if(t!==e.id)return e[p]=!1,!1;try{const n=b.verify(y(e.sig),y(t),y(e.pubkey));return e[p]=n,n}catch{return e[p]=!1,!1}}};function le(e){if(!re(e))throw new Error("can't serialize event with wrong or missing properties");return JSON.stringify([0,e.pubkey,e.created_at,e.kind,e.tags,e.content])}function _(e){let t=N(ae.encode(le(e)));return d(t)}var R=new ce;R.generateSecretKey;R.getPublicKey;R.finalizeEvent;var ue=R.verifyEvent,he=22242;function de(e,t){if(e.ids&&e.ids.indexOf(t.id)===-1||e.kinds&&e.kinds.indexOf(t.kind)===-1||e.authors&&e.authors.indexOf(t.pubkey)===-1)return!1;for(let n in e)if(n[0]==="#"){let s=n.slice(1),i=e[`#${s}`];if(i&&!t.tags.find(([o,r])=>o===n.slice(1)&&i.indexOf(r)!==-1))return!1}return!(e.since&&t.created_at<e.since||e.until&&t.created_at>e.until)}function fe(e,t){for(let n=0;n<e.length;n++)if(de(e[n],t))return!0;return!1}function ye(e,t){let n=t.length+3,s=e.indexOf(`"${t}":`)+n,i=e.slice(s).indexOf('"')+s+1;return e.slice(i,i+64)}function be(e){let t=e.slice(0,22).indexOf('"EVENT"');if(t===-1)return null;let n=e.slice(t+7+1).indexOf('"');if(n===-1)return null;let s=t+7+1+n,i=e.slice(s+1,80).indexOf('"');if(i===-1)return null;let o=s+1+i;return e.slice(s+1,o)}function pe(e,t){return{kind:he,created_at:Math.floor(Date.now()/1e3),tags:[["relay",e],["challenge",t]],content:""}}var K=class extends Error{constructor(e,t){super(`Tried to send message '${e} on a closed connection to ${t}.`),this.name="SendingOnClosedConnection"}},M=class{url;_connected=!1;onclose=null;onnotice=e=>console.debug(`NOTICE from ${this.url}: ${e}`);onauth;baseEoseTimeout=4400;publishTimeout=4400;pingFrequency=29e3;pingTimeout=2e4;resubscribeBackoff=[1e4,1e4,1e4,2e4,2e4,3e4,6e4];openSubs=new Map;enablePing;enableReconnect;idleSince=Date.now();ongoingOperations=0;reconnectTimeoutHandle;pingIntervalHandle;reconnectAttempts=0;skipReconnection=!1;connectionPromise;openCountRequests=new Map;openEventPublishes=new Map;ws;challenge;authPromise;serial=0;verifyEvent;_WebSocket;constructor(e,t){this.url=v(e),this.verifyEvent=t.verifyEvent,this._WebSocket=t.websocketImplementation||WebSocket,this.enablePing=t.enablePing,this.enableReconnect=t.enableReconnect||!1}static async connect(e,t){const n=new M(e,t);return await n.connect(t),n}closeAllSubscriptions(e){for(let[t,n]of this.openSubs)n.close(e);this.openSubs.clear();for(let[t,n]of this.openEventPublishes)n.reject(new Error(e));this.openEventPublishes.clear();for(let[t,n]of this.openCountRequests)n.reject(new Error(e));this.openCountRequests.clear()}get connected(){return this._connected}async reconnect(){const e=this.resubscribeBackoff[Math.min(this.reconnectAttempts,this.resubscribeBackoff.length-1)];this.reconnectAttempts++,this.reconnectTimeoutHandle=setTimeout(async()=>{try{await this.connect()}catch{}},e)}handleHardClose(e){this.pingIntervalHandle&&(clearInterval(this.pingIntervalHandle),this.pingIntervalHandle=void 0),this._connected=!1,this.connectionPromise=void 0,this.idleSince=void 0,this.enableReconnect&&!this.skipReconnection?this.reconnect():(this.onclose?.(),this.closeAllSubscriptions(e))}async connect(e){let t;return this.connectionPromise?this.connectionPromise:(this.challenge=void 0,this.authPromise=void 0,this.skipReconnection=!1,this.connectionPromise=new Promise((n,s)=>{e?.timeout&&(t=setTimeout(()=>{s("connection timed out"),this.connectionPromise=void 0,this.skipReconnection=!0,this.onclose?.(),this.handleHardClose("relay connection timed out")},e.timeout)),e?.abort&&(e.abort.onabort=s);try{this.ws=new this._WebSocket(this.url)}catch(i){clearTimeout(t),s(i);return}this.ws.onopen=()=>{this.reconnectTimeoutHandle&&(clearTimeout(this.reconnectTimeoutHandle),this.reconnectTimeoutHandle=void 0),clearTimeout(t),this._connected=!0;const i=this.reconnectAttempts>0;this.reconnectAttempts=0;for(const o of this.openSubs.values()){if(o.eosed=!1,i)for(let r=0;r<o.filters.length;r++)o.lastEmitted&&(o.filters[r].since=o.lastEmitted+1);o.fire()}this.enablePing&&(this.pingIntervalHandle=setInterval(()=>this.pingpong(),this.pingFrequency)),n()},this.ws.onerror=()=>{clearTimeout(t),s("connection failed"),this.connectionPromise=void 0,this.skipReconnection=!0,this.onclose?.(),this.handleHardClose("relay connection failed")},this.ws.onclose=i=>{clearTimeout(t),s(i.message||"websocket closed"),this.handleHardClose("relay connection closed")},this.ws.onmessage=this._onmessage.bind(this)}),this.connectionPromise)}waitForPingPong(){return new Promise(e=>{this.ws.once("pong",()=>e(!0)),this.ws.ping()})}waitForDummyReq(){return new Promise((e,t)=>{if(!this.connectionPromise)return t(new Error(`no connection to ${this.url}, can't ping`));try{const n=this.subscribe([{ids:["aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"],limit:0}],{label:"<forced-ping>",oneose:()=>{e(!0),n.close()},onclose(){e(!0)},eoseTimeout:this.pingTimeout+1e3})}catch(n){t(n)}})}async pingpong(){this.ws?.readyState===1&&(await Promise.any([this.ws&&this.ws.ping&&this.ws.once?this.waitForPingPong():this.waitForDummyReq(),new Promise(t=>setTimeout(()=>t(!1),this.pingTimeout))])||this.ws?.readyState===this._WebSocket.OPEN&&this.ws?.close())}async send(e){if(!this.connectionPromise)throw new K(e,this.url);this.connectionPromise.then(()=>{this.ws?.send(e)})}async auth(e){const t=this.challenge;if(!t)throw new Error("can't perform auth, no challenge was received");return this.authPromise?this.authPromise:(this.authPromise=new Promise(async(n,s)=>{try{let i=await e(pe(this.url,t)),o=setTimeout(()=>{let r=this.openEventPublishes.get(i.id);r&&(r.reject(new Error("auth timed out")),this.openEventPublishes.delete(i.id))},this.publishTimeout);this.openEventPublishes.set(i.id,{resolve:n,reject:s,timeout:o}),this.send('["AUTH",'+JSON.stringify(i)+"]")}catch(i){console.warn("subscribe auth function failed:",i)}}),this.authPromise)}async publish(e){this.idleSince=void 0,this.ongoingOperations++;const t=new Promise((n,s)=>{const i=setTimeout(()=>{const o=this.openEventPublishes.get(e.id);o&&(o.reject(new Error("publish timed out")),this.openEventPublishes.delete(e.id))},this.publishTimeout);this.openEventPublishes.set(e.id,{resolve:n,reject:s,timeout:i})});return this.send('["EVENT",'+JSON.stringify(e)+"]"),this.ongoingOperations--,this.ongoingOperations===0&&(this.idleSince=Date.now()),t}async count(e,t){this.serial++;const n=t?.id||"count:"+this.serial,s=new Promise((i,o)=>{this.openCountRequests.set(n,{resolve:i,reject:o})});return this.send('["COUNT","'+n+'",'+JSON.stringify(e).substring(1)),s}subscribe(e,t){t.label!=="<forced-ping>"&&(this.idleSince=void 0,this.ongoingOperations++);const n=this.prepareSubscription(e,t);return n.fire(),t.abort&&(t.abort.onabort=()=>n.close(String(t.abort.reason||"<aborted>"))),n}prepareSubscription(e,t){this.serial++;const n=t.id||(t.label?t.label+":":"sub:")+this.serial,s=new ge(this,n,e,t);return this.openSubs.set(n,s),s}close(){this.skipReconnection=!0,this.reconnectTimeoutHandle&&(clearTimeout(this.reconnectTimeoutHandle),this.reconnectTimeoutHandle=void 0),this.pingIntervalHandle&&(clearInterval(this.pingIntervalHandle),this.pingIntervalHandle=void 0),this.closeAllSubscriptions("relay connection closed by us"),this._connected=!1,this.idleSince=void 0,this.onclose?.(),this.ws?.readyState===this._WebSocket.OPEN&&this.ws?.close()}_onmessage(e){const t=e.data;if(!t)return;const n=be(t);if(n){const s=this.openSubs.get(n);if(!s)return;const i=ye(t,"id"),o=s.alreadyHaveEvent?.(i);if(s.receivedEvent?.(this,i),o)return}try{let s=JSON.parse(t);switch(s[0]){case"EVENT":{const i=this.openSubs.get(s[1]),o=s[2];this.verifyEvent(o)&&fe(i.filters,o)&&i.onevent(o),(!i.lastEmitted||i.lastEmitted<o.created_at)&&(i.lastEmitted=o.created_at);return}case"COUNT":{const i=s[1],o=s[2],r=this.openCountRequests.get(i);r&&(r.resolve(o.count),this.openCountRequests.delete(i));return}case"EOSE":{const i=this.openSubs.get(s[1]);if(!i)return;i.receivedEose();return}case"OK":{const i=s[1],o=s[2],r=s[3],c=this.openEventPublishes.get(i);c&&(clearTimeout(c.timeout),o?c.resolve(r):c.reject(new Error(r)),this.openEventPublishes.delete(i));return}case"CLOSED":{const i=s[1],o=this.openSubs.get(i);if(!o)return;o.closed=!0,o.close(s[2]);return}case"NOTICE":{this.onnotice(s[1]);return}case"AUTH":{this.challenge=s[1],this.onauth&&this.auth(this.onauth);return}default:{this.openSubs.get(s[1])?.oncustom?.(s);return}}}catch(s){const[i,o,r]=JSON.parse(t);window.printer.maybe(r.pubkey,":: caught err",r,this.url,s);return}}},ge=class{relay;id;lastEmitted;closed=!1;eosed=!1;filters;alreadyHaveEvent;receivedEvent;onevent;oneose;onclose;oncustom;eoseTimeout;eoseTimeoutHandle;constructor(e,t,n,s){if(n.length===0)throw new Error("subscription can't be created with zero filters");this.relay=e,this.filters=n,this.id=t,this.alreadyHaveEvent=s.alreadyHaveEvent,this.receivedEvent=s.receivedEvent,this.eoseTimeout=s.eoseTimeout||e.baseEoseTimeout,this.oneose=s.oneose,this.onclose=s.onclose,this.onevent=s.onevent||(i=>{console.warn(`onevent() callback not defined for subscription '${this.id}' in relay ${this.relay.url}. event received:`,i)})}fire(){this.relay.send('["REQ","'+this.id+'",'+JSON.stringify(this.filters).substring(1)),this.eoseTimeoutHandle=setTimeout(this.receivedEose.bind(this),this.eoseTimeout)}receivedEose(){this.eosed||(clearTimeout(this.eoseTimeoutHandle),this.eosed=!0,this.oneose?.())}close(e="closed by caller"){if(!this.closed&&this.relay.connected){try{this.relay.send('["CLOSE",'+JSON.stringify(this.id)+"]")}catch(t){if(!(t instanceof K))throw t}this.closed=!0}this.relay.openSubs.delete(this.id),this.relay.ongoingOperations--,this.relay.ongoingOperations===0&&(this.relay.idleSince=Date.now()),this.onclose?.(e)}},me=e=>(e[p]=!0,!0),we=class{relays=new Map;seenOn=new Map;trackRelays=!1;verifyEvent;enablePing;enableReconnect;automaticallyAuth;trustedRelayURLs=new Set;onRelayConnectionFailure;onRelayConnectionSuccess;allowConnectingToRelay;maxWaitForConnection;_WebSocket;constructor(e){this.verifyEvent=e.verifyEvent,this._WebSocket=e.websocketImplementation,this.enablePing=e.enablePing,this.enableReconnect=e.enableReconnect||!1,this.automaticallyAuth=e.automaticallyAuth,this.onRelayConnectionFailure=e.onRelayConnectionFailure,this.onRelayConnectionSuccess=e.onRelayConnectionSuccess,this.allowConnectingToRelay=e.allowConnectingToRelay,this.maxWaitForConnection=e.maxWaitForConnection||3e3}async ensureRelay(e,t){e=v(e);let n=this.relays.get(e);if(n||(n=new M(e,{verifyEvent:this.trustedRelayURLs.has(e)?me:this.verifyEvent,websocketImplementation:this._WebSocket,enablePing:this.enablePing,enableReconnect:this.enableReconnect}),n.onclose=()=>{this.relays.delete(e)},this.relays.set(e,n)),this.automaticallyAuth){const s=this.automaticallyAuth(e);s&&(n.onauth=s)}try{await n.connect({timeout:t?.connectionTimeout,abort:t?.abort})}catch(s){throw this.relays.delete(e),s}return n}close(e){e.map(v).forEach(t=>{this.relays.get(t)?.close(),this.relays.delete(t)})}subscribe(e,t,n){const s=[],i=[];for(let o=0;o<e.length;o++){const r=v(e[o]);s.find(c=>c.url===r)||i.indexOf(r)===-1&&(i.push(r),s.push({url:r,filter:t}))}return this.subscribeMap(s,n)}subscribeMany(e,t,n){return this.subscribe(e,t,n)}subscribeMap(e,t){const n=new Map;for(const a of e){const{url:l,filter:h}=a;n.has(l)||n.set(l,[]),n.get(l).push(h)}const s=Array.from(n.entries()).map(([a,l])=>({url:a,filters:l}));this.trackRelays&&(t.receivedEvent=(a,l)=>{let h=this.seenOn.get(l);h||(h=new Set,this.seenOn.set(l,h)),h.add(a)});const i=new Set,o=[],r=[];let c=a=>{r[a]||(r[a]=!0,r.filter(l=>l).length===s.length&&(t.oneose?.(),c=()=>{}))};const u=[];let f=(a,l)=>{u[a]||(c(a),u[a]=l,u.filter(h=>h).length===s.length&&(t.onclose?.(u),f=()=>{}))};const g=a=>{if(t.alreadyHaveEvent?.(a))return!0;const l=i.has(a);return i.add(a),l},E=Promise.all(s.map(async({url:a,filters:l},h)=>{if(this.allowConnectingToRelay?.(a,["read",l])===!1){f(h,"connection skipped by allowConnectingToRelay");return}let S;try{S=await this.ensureRelay(a,{connectionTimeout:this.maxWaitForConnection<(t.maxWait||0)?Math.max(t.maxWait*.8,t.maxWait-1e3):this.maxWaitForConnection,abort:t.abort})}catch(w){this.onRelayConnectionFailure?.(a),f(h,w?.message||String(w));return}this.onRelayConnectionSuccess?.(a);let J=S.subscribe(l,{...t,oneose:()=>c(h),onclose:w=>{w.startsWith("auth-required: ")&&t.onauth?S.auth(t.onauth).then(()=>{S.subscribe(l,{...t,oneose:()=>c(h),onclose:O=>{f(h,O)},alreadyHaveEvent:g,eoseTimeout:t.maxWait,abort:t.abort})}).catch(O=>{f(h,`auth was required and attempted, but failed with: ${O}`)}):f(h,w)},alreadyHaveEvent:g,eoseTimeout:t.maxWait,abort:t.abort});o.push(J)}));return{async close(a){await E,o.forEach(l=>{l.close(a)})}}}subscribeEose(e,t,n){const s=this.subscribe(e,t,{...n,oneose(){s.close("closed automatically on eose")}});return s}subscribeManyEose(e,t,n){return this.subscribeEose(e,t,n)}async querySync(e,t,n){return new Promise(async s=>{const i=[];this.subscribeEose(e,t,{...n,onevent(o){i.push(o)},onclose(o){s(i)}})})}async get(e,t,n){t.limit=1;const s=await this.querySync(e,t,n);return s.sort((i,o)=>o.created_at-i.created_at),s[0]||null}publish(e,t,n){return e.map(v).map(async(s,i,o)=>{if(o.indexOf(s)!==i)return Promise.reject("duplicate url");if(this.allowConnectingToRelay?.(s,["write",t])===!1)return Promise.reject("connection skipped by allowConnectingToRelay");let r;try{r=await this.ensureRelay(s,{connectionTimeout:this.maxWaitForConnection<(n?.maxWait||0)?Math.max(n.maxWait*.8,n.maxWait-1e3):this.maxWaitForConnection,abort:n?.abort})}catch(c){return this.onRelayConnectionFailure?.(s),"connection failure: "+String(c)}return r.publish(t).catch(async c=>{if(c instanceof Error&&c.message.startsWith("auth-required: ")&&n?.onauth)return await r.auth(n.onauth),r.publish(t);throw c}).then(c=>{if(this.trackRelays){let u=this.seenOn.get(t.id);u||(u=new Set,this.seenOn.set(t.id,u)),u.add(r)}return c})})}listConnectionStatus(){const e=new Map;return this.relays.forEach((t,n)=>e.set(n,t.connected)),e}destroy(){this.relays.forEach(e=>e.close()),this.relays=new Map}pruneIdleRelays(e=1e4){const t=[];for(const[n,s]of this.relays)s.idleSince&&Date.now()-s.idleSince>=e&&(this.relays.delete(n),t.push(n),s.close());return t}},q;try{q=WebSocket}catch{}var ve=class extends we{constructor(e){super({verifyEvent:ue,websocketImplementation:q,maxWaitForConnection:3e3,...e})}};const Ee=["wss://relay.anmore.me","wss://relay.damus.io","wss://nos.lol","wss://relay.primal.net"],Se="npub19djteyezrkn9ppg6gjfsxl59pgxrwh76uju60lxtcvr5svj3cmlsf54ca2",H=Ee;function Oe(){const e=Z(),t=x(e),n=L(e),s=A(t);return{secretKey:e,publicKey:t,nsec:n,npub:s}}function Te(e){const t=new Uint8Array(e.length/2);for(let n=0;n<e.length;n+=2)t[n/2]=parseInt(e.substr(n,2),16);return t}function Pe(e){return Array.from(e).map(t=>t.toString(16).padStart(2,"0")).join("")}function Ce(e){const t=Pe(e);sessionStorage.setItem("nostr_secret_key",t)}function $e(){const e=sessionStorage.getItem("nostr_secret_key");if(!e)return null;const t=Te(e),n=x(t),s=L(t),i=A(n);return{secretKey:t,publicKey:n,nsec:s,npub:i}}function _e(e){try{const t=F(e);if(t.type!=="nsec")return null;const n=t.data,s=x(n),i=A(s);return{secretKey:n,publicKey:s,nsec:e,npub:i}}catch(t){return console.error("Invalid nsec:",t),null}}function ke(){const e=F(Se);if(e.type!=="npub")throw new Error("Invalid recipient npub");return e.data}async function He(e,t,n){try{const s=ke(),i=x(e);n?.("Encrypting message...");const o=await se(e,s,t),r={kind:4,created_at:Math.floor(Date.now()/1e3),tags:[["p",s]],content:o},c=ee(r,e);n?.("Connecting to relays...");const u=new ve,f=H.map(async a=>{try{return n?.(`Publishing to ${a}...`),await u.publish([a],c),!0}catch(l){return console.error(`Failed to publish to ${a}:`,l),!1}}),g=await Promise.allSettled(f);u.close(H);const E=g.filter(a=>a.status==="fulfilled"&&a.value).length;return n?.(`Published to ${E}/${H.length} relays`),E>0}catch(s){return console.error("Error sending DM:",s),!1}}function Ae(e){const{profile:t,formType:n,formData:s,geoJSON:i,email:o}=e;let r=`
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>${n} Submission</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; }
    h1 { color: #16a34a; }
    h2 { color: #15803d; margin-top: 30px; }
    .field { margin: 10px 0; }
    .label { font-weight: bold; color: #374151; }
    .value { margin-left: 10px; color: #1f2937; }
    .geo-data { background: #f3f4f6; padding: 10px; border-radius: 5px; overflow-x: auto; }
    pre { background: #1f2937; color: #f3f4f6; padding: 15px; border-radius: 5px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>${n} Submission</h1>
  <p><em>Submitted: ${new Date().toLocaleString()}</em></p>
  
  <h2>Contributor Profile</h2>
  <div class="field">
    <span class="label">Name:</span>
    <span class="value">${t.name||"bikeuser"}</span>
    ${t.optIn?" <em>(opted-in for public display)</em>":" <em>(anonymous)</em>"}
  </div>
  <div class="field">
    <span class="label">Nostr Pubkey:</span>
    <span class="value">${t.npub}</span>
  </div>
  ${t.bio?`<div class="field"><span class="label">Bio:</span><span class="value">${t.bio}</span></div>`:""}
  ${t.contact?`<div class="field"><span class="label">Contact:</span><span class="value">${t.contact}</span></div>`:""}
  ${o?`<div class="field"><span class="label">Email:</span><span class="value">${o}</span></div>`:""}
  
  <h2>Form Data</h2>
`;for(const[c,u]of Object.entries(s))u&&c!=="geoJSON"&&(r+=`  <div class="field">
    <span class="label">${c.replace(/([A-Z])/g," $1").replace(/^./,f=>f.toUpperCase())}:</span>
    <span class="value">${u}</span>
  </div>
`);return i&&(r+=`
  <h2>Map Data (GeoJSON)</h2>
  <div class="geo-data">
    <pre>${JSON.stringify(i,null,2)}</pre>
  </div>
`),r+=`
</body>
</html>`,r}const U="anmore_user_profile";function Ie(e){localStorage.setItem(U,JSON.stringify(e))}function Ne(){const e=localStorage.getItem(U);if(!e)return null;try{return JSON.parse(e)}catch(t){return console.error("Error parsing profile:",t),null}}function We(e){return e&&e.optIn&&e.name?e.name:"bikeuser"}export{Ne as a,We as b,Oe as c,Ce as d,Ie as e,Ae as f,$e as g,_e as h,He as s};
