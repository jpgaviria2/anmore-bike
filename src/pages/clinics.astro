---
/**
 * Bike Clinics Page
 * 
 * Volunteer instructor signup and clinic schedules.
 * No map needed - simple form for skills, certifications, and availability.
 */

import Layout from '../layouts/Layout.astro';
import Navigation from '../components/Navigation.astro';
import ProfileModal from '../components/ProfileModal.astro';
---

<Layout title="Bike Clinics - Anmore.bike">
  <Navigation />
  <ProfileModal />
  
  <div class="container mx-auto px-4 py-8 md:py-12 max-w-4xl">
    <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">Bike Clinics</h1>
    <p class="text-lg text-gray-700 mb-8">
      Learn bike maintenance, safety skills, and riding techniques through hands-on clinics. 
      Or volunteer to teach and share your expertise with the community!
    </p>
    
    <!-- User Status -->
    <div id="user-status" class="mb-6 bg-white border-2 border-gray-200 rounded-lg p-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
          <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
        </div>
        <div>
          <p class="text-sm text-gray-600">Logged in as</p>
          <p id="display-name" class="font-semibold text-gray-900">bikeuser</p>
        </div>
      </div>
      <button id="login-btn" class="text-green-600 hover:text-green-700 font-semibold text-sm">Login with Key</button>
    </div>
    
    <!-- Upcoming Clinics Info -->
    <div class="bg-green-50 border-2 border-green-200 rounded-xl p-6 mb-8">
      <h2 class="text-xl font-bold text-green-900 mb-3">ðŸ“… Upcoming Clinics</h2>
      <p class="text-green-800 mb-4">Check back for scheduled clinic dates. We partner with TORCA (Tri-Cities Off-Road Cycling Association) to offer:</p>
      <ul class="text-green-800 space-y-2 ml-4">
        <li>â€¢ <strong>Basic Maintenance:</strong> Fix a flat, adjust brakes, clean & lube chain</li>
        <li>â€¢ <strong>Safety Skills:</strong> Hand signals, road rules, visibility tips</li>
        <li>â€¢ <strong>Riding Techniques:</strong> Group riding, trail etiquette, climbing & descending</li>
        <li>â€¢ <strong>Youth Clinics:</strong> Fun skills courses for kids</li>
      </ul>
    </div>
    
    <!-- Volunteer Instructor Form -->
    <form id="clinics-form" class="bg-white rounded-xl shadow-lg p-6 md:p-8 space-y-6">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Volunteer as an Instructor</h2>
      
      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <label for="instructor-name" class="block text-sm font-semibold text-gray-700 mb-2">
            Your Name <span class="text-red-500">*</span>
          </label>
          <input type="text" id="instructor-name" name="instructorName" required 
            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none transition" />
        </div>
        
        <div>
          <label for="experience" class="block text-sm font-semibold text-gray-700 mb-2">
            Years of Cycling Experience
          </label>
          <input type="number" id="experience" name="experience" 
            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none transition" />
        </div>
      </div>
      
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-3">
          Skills You Can Teach <span class="text-red-500">*</span>
        </label>
        <div class="grid md:grid-cols-2 gap-3">
          <label class="flex items-center gap-2">
            <input type="checkbox" name="skills" value="basic-maintenance" class="w-4 h-4 text-green-600 rounded">
            <span>Basic Maintenance</span>
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" name="skills" value="advanced-repair" class="w-4 h-4 text-green-600 rounded">
            <span>Advanced Repair</span>
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" name="skills" value="safety-skills" class="w-4 h-4 text-green-600 rounded">
            <span>Safety Skills</span>
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" name="skills" value="group-riding" class="w-4 h-4 text-green-600 rounded">
            <span>Group Riding</span>
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" name="skills" value="youth-instruction" class="w-4 h-4 text-green-600 rounded">
            <span>Youth Instruction</span>
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" name="skills" value="trail-skills" class="w-4 h-4 text-green-600 rounded">
            <span>Trail/MTB Skills</span>
          </label>
        </div>
      </div>
      
      <div>
        <label for="certifications" class="block text-sm font-semibold text-gray-700 mb-2">
          Certifications or Qualifications
        </label>
        <textarea id="certifications" name="certifications" rows="3" placeholder="e.g., CAN-BIKE Instructor, PMBIA, First Aid, etc."
          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none transition resize-none"></textarea>
      </div>
      
      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <label for="age-groups" class="block text-sm font-semibold text-gray-700 mb-2">
            Preferred Age Groups
          </label>
          <select id="age-groups" name="ageGroups" multiple size="4"
            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none transition">
            <option value="kids-5-10">Kids (5-10)</option>
            <option value="youth-11-17">Youth (11-17)</option>
            <option value="adults">Adults</option>
            <option value="all">All Ages</option>
          </select>
          <p class="text-xs text-gray-500 mt-1">Hold Ctrl/Cmd to select multiple</p>
        </div>
        
        <div>
          <label for="availability" class="block text-sm font-semibold text-gray-700 mb-2">
            Typical Availability
          </label>
          <select id="availability" name="availability"
            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none transition">
            <option value="">Select...</option>
            <option value="weekends">Weekends</option>
            <option value="weekday-evenings">Weekday Evenings</option>
            <option value="flexible">Flexible</option>
            <option value="occasional">Occasional</option>
          </select>
        </div>
      </div>
      
      <div>
        <label for="equipment" class="block text-sm font-semibold text-gray-700 mb-2">
          Equipment/Tools Available
        </label>
        <input type="text" id="equipment" name="equipment" placeholder="e.g., Bike repair stand, full tool kit, spare parts"
          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none transition" />
      </div>
      
      <div>
        <label for="notes" class="block text-sm font-semibold text-gray-700 mb-2">
          Additional Information
        </label>
        <textarea id="notes" name="notes" rows="3" placeholder="Anything else we should know about your skills, interests, or availability..."
          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none transition resize-none"></textarea>
      </div>
      
      <div class="border-t-2 border-gray-200 pt-6">
        <label for="email" class="block text-sm font-semibold text-gray-700 mb-2">
          Email <span class="text-red-500">*</span>
        </label>
        <input type="email" id="email" name="email" required placeholder="your@email.com"
          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none transition" />
      </div>
      
      <div class="pt-4">
        <button type="submit" 
          class="w-full bg-green-600 text-white py-4 rounded-lg font-bold text-lg hover:bg-green-700 transition shadow-lg disabled:bg-gray-400 disabled:cursor-not-allowed">
          Submit Instructor Volunteer Form
        </button>
      </div>
      
      <div id="submit-progress" class="hidden">
        <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
          <p id="progress-text" class="text-sm text-blue-900 text-center"></p>
        </div>
      </div>
    </form>
  </div>
  
  <script>
    import { sendEncryptedDM, formatFormAsHTML } from '../lib/nostr.ts';
    import { getProfile, getDisplayName } from '../lib/profile.ts';
    import { getStoredKeypair } from '../lib/nostr.ts';
    
    function updateDisplayName() {
      const profile = getProfile();
      const displayNameEl = document.getElementById('display-name');
      if (displayNameEl) displayNameEl.textContent = getDisplayName(profile);
    }
    
    updateDisplayName();
    
    document.getElementById('login-btn')?.addEventListener('click', () => {
      (window as any).showLoginModal();
    });
    
    window.addEventListener('user-logged-in', () => updateDisplayName());
    
    const form = document.getElementById('clinics-form') as HTMLFormElement;
    const submitProgress = document.getElementById('submit-progress');
    const progressText = document.getElementById('progress-text');
    
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      let keypair = getStoredKeypair();
      let profile = getProfile();
      
      if (!keypair || !profile) {
        (window as any).showProfileModal();
        await new Promise((resolve) => {
          window.addEventListener('profile-created', resolve, { once: true });
        });
        keypair = getStoredKeypair();
        profile = getProfile();
      }
      
      if (!keypair || !profile) {
        alert('Failed to create profile. Please try again.');
        return;
      }
      
      const formData = new FormData(form);
      const clinicsData: any = {};
      
      const skills: string[] = [];
      formData.getAll('skills').forEach(s => skills.push(s as string));
      const ageGroups: string[] = [];
      formData.getAll('ageGroups').forEach(ag => ageGroups.push(ag as string));
      
      formData.forEach((value, key) => {
        if (key === 'skills') {
          clinicsData.skills = skills.join(', ');
        } else if (key === 'ageGroups') {
          clinicsData.ageGroups = ageGroups.join(', ');
        } else if (value) {
          clinicsData[key] = value;
        }
      });
      
      const messageData = {
        profile,
        formType: 'Bike Clinic Instructor Volunteer',
        formData: clinicsData,
        email: clinicsData.email
      };
      
      const htmlMessage = formatFormAsHTML(messageData);
      
      submitProgress?.classList.remove('hidden');
      const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
      if (submitBtn) submitBtn.disabled = true;
      
      const success = await sendEncryptedDM(
        keypair.secretKey,
        htmlMessage,
        (status) => {
          if (progressText) progressText.textContent = status;
        }
      );
      
      if (success) {
        const isFirstSubmission = !localStorage.getItem('has_submitted');
        if (isFirstSubmission) {
          (window as any).showNsecModal(keypair.nsec);
          localStorage.setItem('has_submitted', 'true');
        } else {
          alert('Volunteer form submitted successfully!');
        }
        form.reset();
      } else {
        alert('Failed to submit. Please check your connection and try again.');
      }
      
      submitProgress?.classList.add('hidden');
      if (submitBtn) submitBtn.disabled = false;
    });
  </script>
</Layout>
