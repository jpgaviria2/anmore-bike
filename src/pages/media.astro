---
/**
 * Media Page
 * 
 * Photos and posts from Anmore.bike community events and rides.
 * Posts loaded from public/data/posts.json for easy additions.
 */

import Layout from '../layouts/Layout.astro';
import Navigation from '../components/Navigation.astro';
import ProfileModal from '../components/ProfileModal.astro';
import fs from 'node:fs';
import path from 'node:path';

const base = import.meta.env.BASE_URL;

// Load posts from JSON
let posts: any[] = [];
try {
  const jsonPath = path.join(process.cwd(), 'public', 'data', 'posts.json');
  const raw = fs.readFileSync(jsonPath, 'utf-8');
  posts = JSON.parse(raw).posts || [];
} catch (e) {
  posts = [];
}

// Sort by date descending
posts.sort((a: any, b: any) => new Date(b.date).getTime() - new Date(a.date).getTime());
---

<Layout title="Media - Anmore.bike">
  <Navigation />
  <ProfileModal />
  
  <div class="container mx-auto px-4 py-8 md:py-12 max-w-5xl">
    <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">ðŸ“¸ Media</h1>
    <p class="text-lg text-gray-700 mb-8">
      Photos and stories from the Anmore.bike community â€” rides, events, and everything in between.
    </p>
    
    <!-- Posts -->
    <div class="space-y-12">
      {posts.map(post => (
        <article class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100">
          <div class="p-6">
            <div class="flex items-center gap-2 text-sm text-green-600 font-semibold uppercase tracking-wide mb-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <time>{new Date(post.date + 'T12:00:00').toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</time>
            </div>
            <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-3">{post.title}</h2>
            <p class="text-gray-700 leading-relaxed mb-6">{post.description}</p>

            {/* Photo grid */}
            {post.images && post.images.length === 1 ? (
              <div class="overflow-hidden rounded-lg">
                <img
                  src={`${base}${post.images[0].replace(/^\//, '')}`}
                  alt={post.title}
                  class="w-full max-h-[500px] object-cover hover:scale-105 transition-transform duration-300 cursor-pointer lightbox-img"
                  loading="lazy"
                />
              </div>
            ) : (
              <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                {post.images.map((img: string) => (
                  <div class="overflow-hidden rounded-lg shadow-md hover:shadow-xl transition-shadow duration-300">
                    <img
                      src={`${base}${img.replace(/^\//, '')}`}
                      alt={post.title}
                      class="w-full h-48 md:h-64 object-cover hover:scale-105 transition-transform duration-300 cursor-pointer lightbox-img"
                      loading="lazy"
                    />
                  </div>
                ))}
              </div>
            )}
          </div>
        </article>
      ))}
    </div>

    {posts.length === 0 && (
      <div class="text-center py-16 text-gray-500">
        <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
        <p class="text-lg">No posts yet â€” check back soon!</p>
      </div>
    )}
  </div>

  <!-- Lightbox -->
  <div id="lightbox" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center cursor-pointer">
    <img id="lightbox-img" src="" alt="" class="max-w-[95vw] max-h-[90vh] object-contain rounded-lg shadow-2xl" />
    <button class="absolute top-4 right-4 text-white text-4xl font-bold hover:text-green-400 transition">&times;</button>
  </div>

  <script>
    // Lightbox functionality
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightbox-img') as HTMLImageElement;

    document.querySelectorAll('.lightbox-img').forEach(img => {
      img.addEventListener('click', () => {
        if (lightbox && lightboxImg) {
          lightboxImg.src = (img as HTMLImageElement).src;
          lightboxImg.alt = (img as HTMLImageElement).alt;
          lightbox.classList.remove('hidden');
          lightbox.classList.add('flex');
        }
      });
    });

    lightbox?.addEventListener('click', () => {
      lightbox.classList.add('hidden');
      lightbox.classList.remove('flex');
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && lightbox) {
        lightbox.classList.add('hidden');
        lightbox.classList.remove('flex');
      }
    });
  </script>
</Layout>
