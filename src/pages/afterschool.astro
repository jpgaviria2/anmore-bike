---
/**
 * Afterschool Programs Registration Page
 * 
 * Youth program registration with comprehensive participant information.
 * Partnerships: 1st Anmore Scouts, Anmore Youth Group
 */

import Layout from '../layouts/Layout.astro';
import Navigation from '../components/Navigation.astro';
import ProfileModal from '../components/ProfileModal.astro';
---

<Layout title="Afterschool Bike Programs - Anmore.bike">
  <Navigation />
  <ProfileModal />
  
  <div class="container mx-auto px-4 py-8 md:py-12 max-w-4xl">
    <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">Afterschool Bike Programs</h1>
    <p class="text-lg text-gray-700 mb-6">
      Youth bike programs for kids and teens! We partner with 1st Anmore Scouts and Anmore Youth Group 
      to offer fun, skill-building bike activities after school.
    </p>
    
    <!-- User Status -->
    <div id="user-status" class="mb-6 bg-white border-2 border-gray-200 rounded-lg p-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
          <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
        </div>
        <div>
          <p class="text-sm text-gray-600">Logged in as</p>
          <p id="display-name" class="font-semibold text-gray-900">bikeuser</p>
        </div>
      </div>
      <button id="login-btn" class="text-green-600 hover:text-green-700 font-semibold text-sm">Login with Key</button>
    </div>
    
    <!-- Program Info -->
    <div class="grid md:grid-cols-2 gap-4 mb-8">
      <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
        <h3 class="font-bold text-blue-900 mb-2">ðŸš´ Program Activities</h3>
        <ul class="text-sm text-blue-800 space-y-1">
          <li>â€¢ Trail riding & skills courses</li>
          <li>â€¢ Bike maintenance workshops</li>
          <li>â€¢ Safety & road rules</li>
          <li>â€¢ Fun challenges & games</li>
        </ul>
      </div>
      <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-4">
        <h3 class="font-bold text-purple-900 mb-2">ðŸ‘¥ Our Partners</h3>
        <ul class="text-sm text-purple-800 space-y-1">
          <li>â€¢ 1st Anmore Scouts</li>
          <li>â€¢ Anmore Youth Group</li>
          <li>â€¢ TORCA volunteers</li>
          <li>â€¢ Local bike shops</li>
        </ul>
      </div>
    </div>
    
    <!-- Registration Form -->
    <form id="afterschool-form" class="bg-white rounded-xl shadow-lg p-6 md:p-8 space-y-6">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Program Registration</h2>
      
      <!-- Participant Info -->
      <div>
        <h3 class="text-lg font-bold text-gray-900 mb-4">Participant Information</h3>
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label for="child-name" class="block text-sm font-semibold text-gray-700 mb-2">
              Child's Full Name <span class="text-red-500">*</span>
            </label>
            <input type="text" id="child-name" name="childName" required 
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none transition" />
          </div>
          
          <div>
            <label for="age" class="block text-sm font-semibold text-gray-700 mb-2">
              Age / Grade <span class="text-red-500">*</span>
            </label>
            <input type="text" id="age" name="age" required placeholder="e.g., 10 / Grade 5"
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none transition" />
          </div>
          
          <div>
            <label for="experience" class="block text-sm font-semibold text-gray-700 mb-2">
              Riding Experience Level <span class="text-red-500">*</span>
            </label>
            <select id="experience" name="experience" required
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none transition">
              <option value="">Select level...</option>
              <option value="none">None - Just learning</option>
              <option value="beginner">Beginner - Can ride with help</option>
              <option value="intermediate">Intermediate - Rides confidently</option>
              <option value="advanced">Advanced - Skilled rider</option>
            </select>
          </div>
          
          <div>
            <label for="bike-ownership" class="block text-sm font-semibold text-gray-700 mb-2">
              Bike Ownership <span class="text-red-500">*</span>
            </label>
            <select id="bike-ownership" name="bikeOwnership" required
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none transition">
              <option value="">Select...</option>
              <option value="has-bike">Has own bike</option>
              <option value="needs-bike">Needs bike</option>
              <option value="needs-repair">Bike needs repair</option>
            </select>
          </div>
          
          <div>
            <label for="helmet" class="block text-sm font-semibold text-gray-700 mb-2">
              Helmet Availability <span class="text-red-500">*</span>
            </label>
            <select id="helmet" name="helmet" required
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none transition">
              <option value="">Select...</option>
              <option value="has-helmet">Has helmet</option>
              <option value="needs-helmet">Needs helmet</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Parent/Guardian Info -->
      <div class="border-t-2 border-gray-200 pt-6">
        <h3 class="text-lg font-bold text-gray-900 mb-4">Parent/Guardian Information</h3>
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label for="parent-name" class="block text-sm font-semibold text-gray-700 mb-2">
              Full Name <span class="text-red-500">*</span>
            </label>
            <input type="text" id="parent-name" name="parentName" required 
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none transition" />
          </div>
          
          <div>
            <label for="phone" class="block text-sm font-semibold text-gray-700 mb-2">
              Phone Number <span class="text-red-500">*</span>
            </label>
            <input type="tel" id="phone" name="phone" required 
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none transition" />
          </div>
          
          <div>
            <label for="email" class="block text-sm font-semibold text-gray-700 mb-2">
              Email <span class="text-red-500">*</span>
            </label>
            <input type="email" id="email" name="email" required 
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none transition" />
          </div>
          
          <div>
            <label for="emergency-contact" class="block text-sm font-semibold text-gray-700 mb-2">
              Emergency Contact <span class="text-red-500">*</span>
            </label>
            <input type="text" id="emergency-contact" name="emergencyContact" required placeholder="Name & phone"
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none transition" />
          </div>
        </div>
      </div>
      
      <!-- Medical & Accommodations -->
      <div class="border-t-2 border-gray-200 pt-6">
        <h3 class="text-lg font-bold text-gray-900 mb-4">Medical & Accommodations</h3>
        <div class="space-y-4">
          <div>
            <label for="allergies" class="block text-sm font-semibold text-gray-700 mb-2">
              Allergies or Medical Conditions
            </label>
            <textarea id="allergies" name="allergies" rows="2" placeholder="Please list any relevant medical information..."
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none transition resize-none"></textarea>
          </div>
          
          <div>
            <label for="accommodations" class="block text-sm font-semibold text-gray-700 mb-2">
              Behavioral or Learning Accommodations
            </label>
            <textarea id="accommodations" name="accommodations" rows="2" placeholder="Any accommodations we should be aware of..."
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none transition resize-none"></textarea>
          </div>
        </div>
      </div>
      
      <!-- Program Preferences -->
      <div class="border-t-2 border-gray-200 pt-6">
        <h3 class="text-lg font-bold text-gray-900 mb-4">Program Preferences</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-3">
              Interested Activities (select all that apply):
            </label>
            <div class="grid md:grid-cols-2 gap-3">
              <label class="flex items-center gap-2">
                <input type="checkbox" name="activities" value="trail-riding" class="w-4 h-4 text-green-600 rounded">
                <span>Trail Riding</span>
              </label>
              <label class="flex items-center gap-2">
                <input type="checkbox" name="activities" value="skills" class="w-4 h-4 text-green-600 rounded">
                <span>Skills Development</span>
              </label>
              <label class="flex items-center gap-2">
                <input type="checkbox" name="activities" value="maintenance" class="w-4 h-4 text-green-600 rounded">
                <span>Bike Maintenance</span>
              </label>
              <label class="flex items-center gap-2">
                <input type="checkbox" name="activities" value="racing" class="w-4 h-4 text-green-600 rounded">
                <span>Racing/Competition</span>
              </label>
            </div>
          </div>
          
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <label for="session" class="block text-sm font-semibold text-gray-700 mb-2">
                Preferred Session
              </label>
              <select id="session" name="session"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none transition">
                <option value="">Select...</option>
                <option value="spring">Spring Session</option>
                <option value="summer">Summer Session</option>
                <option value="fall">Fall Session</option>
                <option value="year-round">Year-round</option>
              </select>
            </div>
            
            <div>
              <label for="transportation" class="block text-sm font-semibold text-gray-700 mb-2">
                Transportation Needs
              </label>
              <select id="transportation" name="transportation"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none transition">
                <option value="">Select...</option>
                <option value="self">Will provide own transport</option>
                <option value="carpool">Interested in carpool</option>
                <option value="needs-ride">Needs ride</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Waiver -->
      <div class="border-t-2 border-gray-200 pt-6">
        <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4">
          <label class="flex items-start gap-3 cursor-pointer">
            <input type="checkbox" id="waiver" name="waiver" required class="mt-1 w-5 h-5 text-green-600 rounded">
            <div>
              <span class="font-semibold text-gray-900">Liability Waiver Agreement <span class="text-red-500">*</span></span>
              <p class="text-sm text-gray-700 mt-1">
                I understand that biking activities involve inherent risks and I assume all risks associated with participation. 
                I release and hold harmless Anmore.bike, TORCA, and all volunteers from any liability for injuries or damages 
                that may occur during program activities.
              </p>
            </div>
          </label>
        </div>
      </div>
      
      <!-- Parent Volunteer -->
      <div class="border-t-2 border-gray-200 pt-6">
        <div class="bg-green-50 border-2 border-green-200 rounded-lg p-4">
          <label class="flex items-start gap-3 cursor-pointer">
            <input type="checkbox" id="parent-volunteer" name="parentVolunteer" class="mt-1 w-5 h-5 text-green-600 rounded">
            <div>
              <span class="font-semibold text-gray-900">I'm interested in volunteering</span>
              <p class="text-sm text-gray-600 mt-1">
                Help supervise activities, assist with maintenance clinics, or coordinate events
              </p>
            </div>
          </label>
        </div>
      </div>
      
      <div class="pt-4">
        <button type="submit" 
          class="w-full bg-green-600 text-white py-4 rounded-lg font-bold text-lg hover:bg-green-700 transition shadow-lg disabled:bg-gray-400 disabled:cursor-not-allowed">
          Submit Registration
        </button>
      </div>
      
      <div id="submit-progress" class="hidden">
        <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
          <p id="progress-text" class="text-sm text-blue-900 text-center"></p>
        </div>
      </div>
    </form>
  </div>
  
  <script>
    import { sendEncryptedDM, formatFormAsHTML } from '../lib/nostr.ts';
    import { getProfile, getDisplayName } from '../lib/profile.ts';
    import { getStoredKeypair } from '../lib/nostr.ts';
    
    function updateDisplayName() {
      const profile = getProfile();
      const displayNameEl = document.getElementById('display-name');
      if (displayNameEl) displayNameEl.textContent = getDisplayName(profile);
    }
    
    updateDisplayName();
    document.getElementById('login-btn')?.addEventListener('click', () => (window as any).showLoginModal());
    window.addEventListener('user-logged-in', () => updateDisplayName());
    
    const form = document.getElementById('afterschool-form') as HTMLFormElement;
    const submitProgress = document.getElementById('submit-progress');
    const progressText = document.getElementById('progress-text');
    
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      let keypair = getStoredKeypair();
      let profile = getProfile();
      
      if (!keypair || !profile) {
        (window as any).showProfileModal();
        await new Promise((resolve) => window.addEventListener('profile-created', resolve, { once: true }));
        keypair = getStoredKeypair();
        profile = getProfile();
      }
      
      if (!keypair || !profile) {
        alert('Failed to create profile. Please try again.');
        return;
      }
      
      const formData = new FormData(form);
      const registrationData: any = {};
      
      const activities: string[] = [];
      formData.getAll('activities').forEach(a => activities.push(a as string));
      
      formData.forEach((value, key) => {
        if (key === 'activities') {
          registrationData.activities = activities.join(', ');
        } else if (value) {
          registrationData[key] = value;
        }
      });
      
      const messageData = {
        profile,
        formType: 'Afterschool Program Registration',
        formData: registrationData,
        email: registrationData.email
      };
      
      const htmlMessage = formatFormAsHTML(messageData);
      
      submitProgress?.classList.remove('hidden');
      const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
      if (submitBtn) submitBtn.disabled = true;
      
      const success = await sendEncryptedDM(keypair.secretKey, htmlMessage, (status) => {
        if (progressText) progressText.textContent = status;
      });
      
      if (success) {
        const isFirstSubmission = !localStorage.getItem('has_submitted');
        if (isFirstSubmission) {
          (window as any).showNsecModal(keypair.nsec);
          localStorage.setItem('has_submitted', 'true');
        } else {
          alert('Registration submitted successfully!');
        }
        form.reset();
      } else {
        alert('Failed to submit. Please check your connection and try again.');
      }
      
      submitProgress?.classList.add('hidden');
      if (submitBtn) submitBtn.disabled = false;
    });
  </script>
</Layout>
